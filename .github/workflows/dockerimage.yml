name: Docker Image CI

on: [push]

jobs:
  build_docker_image:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag opae-fedora:latest
    - name: Save Docker Image
      run: docker images && docker save opae-fedora:latest > opae-fedora.tar
    - name: Archive unpacked image
      uses: actions/upload-artifact@v1
      with:
        name: opae-fedora
        path: opae-fedora.tar
  build_oci_image:
    needs: build_docker_image
    env:
      GOPATH: ${{ github.workspace }}/go
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@master
      with:
          name: opae-fedora
    - name: Install Packages
      run: sudo apt update && sudo apt install -y libgpgme-dev libassuan-dev btrfs-tools libdevmapper-dev go-md2man
    - name: Setup Go for use with actions
      uses: actions/setup-go@v1.0.0
      # with:
        # The Go version to download (if necessary) and use. Example: 1.9.3
        #version: # optional, default is 1.10
    - name: Build skopeo
      run: git clone https://github.com/containers/skopeo $GOPATH/src/github.com/containers/skopeo &&cd $GOPATH/src/github.com/containers/skopeo && make binary-local && sudo make install
    - name: Convert to OCI bundle
      run: skopeo copy docker-archive:opae-fedora.tar oci:opae-fedora-oci:latest
    - name: Archive oci image artifact
      uses: actions/upload-artifact@v1
      with:
        name: opae-fedora-oci
        path: opae-fedora-oci

name: Docker Image CI

on: [push]

jobs:

  build:
    env:
      GOPATH: ${{ github.workspace }}/go
    runs-on: ubuntu-latest

    steps:
    - name: Install Packages
      run: sudo apt update && sudo apt install -y libgpgme-dev libassuan-dev btrfs-tools libdevmapper-dev go-md2man
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag my-image-name:latest
    - name: Save Docker Image
      run: docker images && docker save my-image-name:latest > my-image.tar      
    - name: Setup Go for use with actions
      uses: actions/setup-go@v1.0.0
      # with:
        # The Go version to download (if necessary) and use. Example: 1.9.3
        #version: # optional, default is 1.10
    - name: Build skopeo
      run: git clone https://github.com/containers/skopeo $GOPATH/src/github.com/containers/skopeo &&cd $GOPATH/src/github.com/containers/skopeo && make binary-local && sudo make install
    - name: Build oci-image-tool
      run: go get -d github.com/opencontainers/image-tools/cmd/oci-image-tool && cd $GOPATH/src/github.com/opencontainers/image-tools/ && make all && sudo make install
    - name: Convert to OCI bundle
      run: skopeo copy docker-archive:my-image.tar oci:my-image-oci:latest
    - name: Tar OCI image
      run: tar -czf my-image-oci.tar.gz my-image-oci
    - name: Archive oci image artifact
      uses: actions/upload-artifact@v1
      with:
        name: my-image-oci
        path: my-image-oci.tar.gz
    - name: Unpack OCI image
      run: sudo oci-image-tool create --ref name=latest my-image-oci my-image-unpacked
    - name: Tar unpacked bundle
      run: sudo tar -czf my-image-unpacked.tar.gz my-image-unpacked && sudo chmod a+r my-image-unpacked.tar.gz
    - name: Archive unpacked image
      uses: actions/upload-artifact@v1
      with:
        name: my-image-unpacked
        path: my-image-unpacked.tar.gz

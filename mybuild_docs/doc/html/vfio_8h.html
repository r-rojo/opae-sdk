<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OPAE C API: opae-libs/include/opae/vfio.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OPAE C API
   &#160;<span id="projectnumber">-..</span>
   </div>
   <div id="projectbrief">FPGA API</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_f6b276e119f657f6304cd27331a4c3c7.html">opae-libs</a></li><li class="navelem"><a class="el" href="dir_1f4dad55880cce8d478fd7ab5bf5f0f9.html">include</a></li><li class="navelem"><a class="el" href="dir_d5cc4b41334fd19f2e3574fb282a209c.html">opae</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">vfio.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>APIs to manage a PCIe device via vfio-pci.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;pthread.h&gt;</code><br />
<code>#include &lt;linux/vfio.h&gt;</code><br />
</div>
<p><a href="vfio_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:structopae__vfio__iova__range"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#structopae__vfio__iova__range">opae_vfio_iova_range</a></td></tr>
<tr class="separator:structopae__vfio__iova__range"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structopae__vfio__group"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#structopae__vfio__group">opae_vfio_group</a></td></tr>
<tr class="separator:structopae__vfio__group"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structopae__vfio__sparse__info"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#structopae__vfio__sparse__info">opae_vfio_sparse_info</a></td></tr>
<tr class="separator:structopae__vfio__sparse__info"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structopae__vfio__device__region"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#structopae__vfio__device__region">opae_vfio_device_region</a></td></tr>
<tr class="separator:structopae__vfio__device__region"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structopae__vfio__device"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#structopae__vfio__device">opae_vfio_device</a></td></tr>
<tr class="separator:structopae__vfio__device"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structopae__vfio__buffer"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#structopae__vfio__buffer">opae_vfio_buffer</a></td></tr>
<tr class="separator:structopae__vfio__buffer"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structopae__vfio"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a></td></tr>
<tr class="separator:structopae__vfio"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a3d3ccbf4a24acbe8f3fc4d973ab46b1a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#a3d3ccbf4a24acbe8f3fc4d973ab46b1a">opae_vfio_open</a> (struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *v, const char *pciaddr)</td></tr>
<tr class="separator:a3d3ccbf4a24acbe8f3fc4d973ab46b1a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d6d1f473a26bc0fbe83e6894b8fb607"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#a8d6d1f473a26bc0fbe83e6894b8fb607">opae_vfio_secure_open</a> (struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *v, const char *pciaddr, const char *token)</td></tr>
<tr class="separator:a8d6d1f473a26bc0fbe83e6894b8fb607"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc30450c9b7ebc22709557cac5ab9181"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#afc30450c9b7ebc22709557cac5ab9181">opae_vfio_region_get</a> (struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *v, uint32_t index, uint8_t **ptr, size_t *size)</td></tr>
<tr class="separator:afc30450c9b7ebc22709557cac5ab9181"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a63c468f18994a45604b372c31a1e26cf"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#a63c468f18994a45604b372c31a1e26cf">opae_vfio_buffer_allocate</a> (struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *v, size_t *size, uint8_t **buf, uint64_t *iova)</td></tr>
<tr class="separator:a63c468f18994a45604b372c31a1e26cf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae2a60d829698d793ab9a4ad351d2596d"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#ae2a60d829698d793ab9a4ad351d2596d">opae_vfio_buffer_free</a> (struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *v, uint8_t *buf)</td></tr>
<tr class="separator:ae2a60d829698d793ab9a4ad351d2596d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a70fd22e64704c8f0090adb810d51fa83"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vfio_8h.html#a70fd22e64704c8f0090adb810d51fa83">opae_vfio_close</a> (struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *v)</td></tr>
<tr class="separator:a70fd22e64704c8f0090adb810d51fa83"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>APIs to manage a PCIe device via vfio-pci. </p>
<p>Presents a simple interface for interacting with a PCIe device that is bound to the vfio-pci driver. See <a href="https://kernel.org/doc/Documentation/vfio.txt">https://kernel.org/doc/Documentation/vfio.txt</a> for a description of vfio-pci.</p>
<p>Provides APIs for opening/closing the device, querying info about the MMIO regions of the device, and allocating/mapping and freeing/unmapping DMA buffers. </p>

<p class="definition">Definition in file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><hr/><h2 class="groupheader">Data Structure Documentation</h2>
<a name="structopae__vfio__iova__range" id="structopae__vfio__iova__range"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structopae__vfio__iova__range">&#9670;&nbsp;</a></span>opae_vfio_iova_range</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct opae_vfio_iova_range</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>IO Virtual Address Range</p>
<p>A range of allocatable IOVA offsets. Used for mapping DMA buffers. </p>

<p class="definition">Definition at line <a class="el" href="vfio_8h_source.html#l00055">55</a> of file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="ae44d6d78fc59fec1829117f80f09d676"></a>uint64_t</td>
<td class="fieldname">
start</td>
<td class="fielddoc">
<p>Start of this range of offsets. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a8e09837d655b7187d704d1dec69bd3e2"></a>uint64_t</td>
<td class="fieldname">
end</td>
<td class="fielddoc">
<p>End of this range of offsets. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a9aa30cca772595b7e9d404df2615351b"></a>uint64_t</td>
<td class="fieldname">
next_ptr</td>
<td class="fielddoc">
<p>The next allocatable offset. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="acdadb8bd4497fd424a045de13f1c0570"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__iova__range">opae_vfio_iova_range</a> *</td>
<td class="fieldname">
next</td>
<td class="fielddoc">
<p>Pointer to next in list. </p>
</td></tr>
</table>

</div>
</div>
<a name="structopae__vfio__group" id="structopae__vfio__group"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structopae__vfio__group">&#9670;&nbsp;</a></span>opae_vfio_group</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct opae_vfio_group</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>VFIO group</p>
<p>Each device managed by vfio-pci belongs to a VFIO group rooted at /dev/vfio/N, where N is the group number. </p>

<p class="definition">Definition at line <a class="el" href="vfio_8h_source.html#l00068">68</a> of file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="aa7f7d7923d85bdb630b0b1ec49be5f92"></a>char *</td>
<td class="fieldname">
group_device</td>
<td class="fielddoc">
<p>Full path to the group device. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a51d7ad18b5d27f7713877bc9e7f31c92"></a>int</td>
<td class="fieldname">
group_fd</td>
<td class="fielddoc">
<p>File descriptor for the group device. </p>
</td></tr>
</table>

</div>
</div>
<a name="structopae__vfio__sparse__info" id="structopae__vfio__sparse__info"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structopae__vfio__sparse__info">&#9670;&nbsp;</a></span>opae_vfio_sparse_info</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct opae_vfio_sparse_info</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>MMIO sparse-mappable region info</p>
<p>Describes a range of sparse-mappable MMIO, for MMIO ranges that have non-contiguous addresses. </p>

<p class="definition">Definition at line <a class="el" href="vfio_8h_source.html#l00079">79</a> of file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="a0f2a85a947a552ace76e299bd66dc91d"></a>uint32_t</td>
<td class="fieldname">
index</td>
<td class="fielddoc">
<p>Region index, from 0. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="afc2d2ce14bb3aeaba49efa5e8a063dfb"></a>uint32_t</td>
<td class="fieldname">
offset</td>
<td class="fielddoc">
<p>Offset of sparse region. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="adefec9a427d225b75b9b272710174df8"></a>uint32_t</td>
<td class="fieldname">
size</td>
<td class="fielddoc">
<p>Size of sparse region. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a68ad8ff776b8b47536d8f515eadffaa4"></a>uint8_t *</td>
<td class="fieldname">
ptr</td>
<td class="fielddoc">
<p>Virtual address of sparse region. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a6557e0f64b5cb7f9e89218aaa535d583"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__sparse__info">opae_vfio_sparse_info</a> *</td>
<td class="fieldname">
next</td>
<td class="fielddoc">
<p>Pointer to next in list. </p>
</td></tr>
</table>

</div>
</div>
<a name="structopae__vfio__device__region" id="structopae__vfio__device__region"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structopae__vfio__device__region">&#9670;&nbsp;</a></span>opae_vfio_device_region</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct opae_vfio_device_region</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>MMIO region info</p>
<p>Describes a range of mappable MMIO. </p>

<p class="definition">Definition at line <a class="el" href="vfio_8h_source.html#l00092">92</a> of file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="a276412974a0b0ffb91ac3200149761b0"></a>uint32_t</td>
<td class="fieldname">
region_index</td>
<td class="fielddoc">
<p>Region index, from 0. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a37bbecd990a16e1d985bece6d8395e86"></a>uint8_t *</td>
<td class="fieldname">
region_ptr</td>
<td class="fielddoc">
<p>Virtual address of region. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="add69a93ef216ab2ed1a053f506605f8e"></a>size_t</td>
<td class="fieldname">
region_size</td>
<td class="fielddoc">
<p>Size of region. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a52a91a9da49e5a61dbb5e8f511733aba"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__sparse__info">opae_vfio_sparse_info</a> *</td>
<td class="fieldname">
region_sparse</td>
<td class="fielddoc">
<p>For sparse regions. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="ad58eb4a337da7515de0acca200a2463c"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__device__region">opae_vfio_device_region</a> *</td>
<td class="fieldname">
next</td>
<td class="fielddoc">
<p>Pointer to next in list. </p>
</td></tr>
</table>

</div>
</div>
<a name="structopae__vfio__device" id="structopae__vfio__device"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structopae__vfio__device">&#9670;&nbsp;</a></span>opae_vfio_device</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct opae_vfio_device</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>VFIO device</p>
<p>Each VFIO device has a file descriptor that is used to query information about the device MMIO regions and config space. </p>

<p class="definition">Definition at line <a class="el" href="vfio_8h_source.html#l00106">106</a> of file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="a5567cac847af54d1b68cd11de6d9071a"></a>int</td>
<td class="fieldname">
device_fd</td>
<td class="fielddoc">
<p>Device file descriptor. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a484988f748aa324957a2046bc2590e10"></a>uint64_t</td>
<td class="fieldname">
device_config_offset</td>
<td class="fielddoc">
<p>Offset of PCIe config space. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="ad9ca3ae45cd69d3eec04297820c98db4"></a>uint32_t</td>
<td class="fieldname">
device_num_regions</td>
<td class="fielddoc">
<p>Total MMIO region count. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="ab45bac066081e611b23ff38c90ab6f26"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__device__region">opae_vfio_device_region</a> *</td>
<td class="fieldname">
regions</td>
<td class="fielddoc">
<p>Region list pointer. </p>
</td></tr>
</table>

</div>
</div>
<a name="structopae__vfio__buffer" id="structopae__vfio__buffer"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structopae__vfio__buffer">&#9670;&nbsp;</a></span>opae_vfio_buffer</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct opae_vfio_buffer</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>System DMA buffer</p>
<p>Describes a system memory address space that is capable of DMA. </p>

<p class="definition">Definition at line <a class="el" href="vfio_8h_source.html#l00118">118</a> of file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="a10c301384270143e76d93675740d2a05"></a>uint8_t *</td>
<td class="fieldname">
buffer_ptr</td>
<td class="fielddoc">
<p>Buffer virtual address. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a52535a9a9d8c7a129fb313d14a96dc47"></a>size_t</td>
<td class="fieldname">
buffer_size</td>
<td class="fielddoc">
<p>Buffer size. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a4bccc7115924108b58c421955a6b9775"></a>uint64_t</td>
<td class="fieldname">
buffer_iova</td>
<td class="fielddoc">
<p>Buffer IOVA address. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a4a373bbf6acc2d47dd674a6ea44771e8"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__buffer">opae_vfio_buffer</a> *</td>
<td class="fieldname">
next</td>
<td class="fielddoc">
<p>Pointer to next in list. </p>
</td></tr>
</table>

</div>
</div>
<a name="structopae__vfio" id="structopae__vfio"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structopae__vfio">&#9670;&nbsp;</a></span>opae_vfio</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct opae_vfio</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>OPAE VFIO device abstraction</p>
<p>This structure is used to interact with the OPAE VFIO API. It tracks data related to the VFIO container, group, and device. A mutex is provided for thread safety. </p>

<p class="definition">Definition at line <a class="el" href="vfio_8h_source.html#l00132">132</a> of file <a class="el" href="vfio_8h_source.html">vfio.h</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="ad9ef4790801de907acfa18409dedfaab"></a>pthread_mutex_t</td>
<td class="fieldname">
lock</td>
<td class="fielddoc">
<p>For thread safety. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a7ca65a6a199f57795216b4af7e152b7e"></a>char *</td>
<td class="fieldname">
cont_device</td>
<td class="fielddoc">
<p>"/dev/vfio/vfio" </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a12cbdd053863723e3b51564dab3b1de5"></a>char *</td>
<td class="fieldname">
cont_pciaddr</td>
<td class="fielddoc">
<p>PCIe address, eg 0000:00:00.0 </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a7cdb7430f296c4c469dc54f075014245"></a>int</td>
<td class="fieldname">
cont_fd</td>
<td class="fielddoc">
<p>Container file descriptor. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a65cb87d5caf739177f1627f369704ea4"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__iova__range">opae_vfio_iova_range</a> *</td>
<td class="fieldname">
cont_ranges</td>
<td class="fielddoc">
<p>List of IOVA ranges. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a5aa9019a215689bb45c6de05425489e0"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__group">opae_vfio_group</a></td>
<td class="fieldname">
group</td>
<td class="fielddoc">
<p>The VFIO device group. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a0321bdb1c77dad0ad3f57d32d5f00de6"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__device">opae_vfio_device</a></td>
<td class="fieldname">
device</td>
<td class="fielddoc">
<p>The VFIO device. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a339f29d4740af95c4c033966188ce52e"></a>struct <a class="el" href="vfio_8h.html#structopae__vfio__buffer">opae_vfio_buffer</a> *</td>
<td class="fieldname">
cont_buffers</td>
<td class="fielddoc">
<p>List of allocated DMA buffers. </p>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a3d3ccbf4a24acbe8f3fc4d973ab46b1a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d3ccbf4a24acbe8f3fc4d973ab46b1a">&#9670;&nbsp;</a></span>opae_vfio_open()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opae_vfio_open </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>pciaddr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Open and populate a VFIO device</p>
<p>Opens the PCIe device corresponding to the address given in pciaddr. The device must be bound to the vfio-pci driver prior to opening it. The data structures corresponding to IOVA space, MMIO regions, and DMA buffers are initialized.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">v</td><td>Storage for the device info. May be stack-resident. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pciaddr</td><td>The PCIe address of the requested device. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Non-zero on error. Zero on success.</dd></dl>
<p>Example </p><div class="fragment"><div class="line">$ sudo opaevfio -i 0000:00:00.0 -u user -g group</div>
</div><!-- fragment --><p>Example </p><div class="fragment"><div class="line"><a class="code" href="vfio_8h.html#structopae__vfio">opae_vfio</a> v;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a3d3ccbf4a24acbe8f3fc4d973ab46b1a">opae_vfio_open</a>(&amp;v, <span class="stringliteral">&quot;0000:00:00.0&quot;</span>)) {</div>
<div class="line">  <span class="comment">// handle error</span></div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
</div>
<a id="a8d6d1f473a26bc0fbe83e6894b8fb607"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8d6d1f473a26bc0fbe83e6894b8fb607">&#9670;&nbsp;</a></span>opae_vfio_secure_open()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opae_vfio_secure_open </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>pciaddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Open and populate a VFIO device</p>
<p>Opens the PCIe device corresponding to the address given in pciaddr, using the VF token (GUID) given in token. The device must be bound to the vfio-pci driver prior to opening it. The data structures corresponding to IOVA space, MMIO regions, and DMA buffers are initialized.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">v</td><td>Storage for the device info. May be stack-resident. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pciaddr</td><td>The PCIe address of the requested device. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">token</td><td>The GUID representing the VF token. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Non-zero on error. Zero on success.</dd></dl>
<p>Example </p><div class="fragment"><div class="line">$ sudo opaevfio -i 0000:00:00.0 -u user -g group</div>
</div><!-- fragment --><p>Example </p><div class="fragment"><div class="line"><a class="code" href="vfio_8h.html#structopae__vfio">opae_vfio</a> v;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a8d6d1f473a26bc0fbe83e6894b8fb607">opae_vfio_secure_open</a>(&amp;v, <span class="stringliteral">&quot;0000:00:00.0&quot;</span>,</div>
<div class="line">                          <span class="stringliteral">&quot;00f5ad6b-2edd-422e-9d1e-34124c686fec&quot;</span>)) {</div>
<div class="line">  <span class="comment">// handle error</span></div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
</div>
<a id="afc30450c9b7ebc22709557cac5ab9181"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afc30450c9b7ebc22709557cac5ab9181">&#9670;&nbsp;</a></span>opae_vfio_region_get()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opae_vfio_region_get </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t **&#160;</td>
          <td class="paramname"><em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t *&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Query device MMIO region</p>
<p>Retrieves info describing the MMIO region with the given region index. The device structure v must have been previously opened by a call to opae_vfio_open.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The open OPAE VFIO device. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">index</td><td>The zero-based index of the desired MMIO region. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ptr</td><td>Optional pointer to receive the virtual address for the region. Pass NULL to ignore. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">size</td><td>Optional pointer to receive the size of the MMIO region. Pass NULL to ignore. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Non-zero on error (including index out-of-range). Zero on success.</dd></dl>
<p>Example </p><div class="fragment"><div class="line"><a class="code" href="vfio_8h.html#structopae__vfio">opae_vfio</a> v;</div>
<div class="line"> </div>
<div class="line">uint8_t *fme_virt = NULL;</div>
<div class="line">uint8_t *port_virt = NULL;</div>
<div class="line"><span class="keywordtype">size_t</span> fme_size = 0;</div>
<div class="line"><span class="keywordtype">size_t</span> port_size = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a3d3ccbf4a24acbe8f3fc4d973ab46b1a">opae_vfio_open</a>(&amp;v, <span class="stringliteral">&quot;0000:00:00.0&quot;</span>)) {</div>
<div class="line">  <span class="comment">// handle error</span></div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  <a class="code" href="vfio_8h.html#afc30450c9b7ebc22709557cac5ab9181">opae_vfio_region_get</a>(&amp;v, 0, &amp;fme_virt, &amp;fme_size);</div>
<div class="line">  <a class="code" href="vfio_8h.html#afc30450c9b7ebc22709557cac5ab9181">opae_vfio_region_get</a>(&amp;v, 2, &amp;port_virt, &amp;port_size);</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
</div>
<a id="a63c468f18994a45604b372c31a1e26cf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a63c468f18994a45604b372c31a1e26cf">&#9670;&nbsp;</a></span>opae_vfio_buffer_allocate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opae_vfio_buffer_allocate </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t *&#160;</td>
          <td class="paramname"><em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t **&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t *&#160;</td>
          <td class="paramname"><em>iova</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Allocate and map system buffer</p>
<p>Allocate, map, and retrieve info for a system buffer capable of DMA. Saves an entry in the v-&gt;cont_buffers list. If the buffer is not explicitly freed by opae_vfio_buffer_free, it will be freed during opae_vfio_close.</p>
<p>mmap is used for the allocation. If the size is greater than 2MB, then the allocation request is fulfilled by a 1GB huge page. Else, if the size is greater than 4096, then the request is fulfilled by a 2MB huge page. Else, the request is fulfilled by the non-huge page pool.</p>
<dl class="section note"><dt>Note</dt><dd>Allocations from the huge page pool require that huge pages be configured on the system. Huge pages may be configured on the kernel boot command prompt. Example default_hugepagesz=1G hugepagesz=1G hugepages=2 hugepagesz=2M hugepages=8</dd>
<dd>
Huge pages may also be configured at runtime. Example sudo sh -c 'echo 8 &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages' sudo sh -c 'echo 2 &gt; /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages'</dd>
<dd>
Be sure that the IOMMU is also enabled using the follow kernel boot command: intel_iommu=on</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">v</td><td>The open OPAE VFIO device. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">size</td><td>A pointer to the requested size. The size may be rounded to the next page size prior to return from the function. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">buf</td><td>Optional pointer to receive the virtual address for the buffer. Pass NULL to ignore. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">iova</td><td>Optional pointer to receive the IOVA address for the buffer. Pass NULL to ignore. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Non-zero on error. Zero on success.</dd></dl>
<p>Example </p><div class="fragment"><div class="line"><a class="code" href="vfio_8h.html#structopae__vfio">opae_vfio</a> v;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">size_t</span> sz;</div>
<div class="line">uint8_t *buf_2m_virt = NULL;</div>
<div class="line">uint8_t *buf_1g_virt = NULL;</div>
<div class="line">uint64_t buf_2m_iova = 0;</div>
<div class="line">uint64_t buf_1g_iova = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a3d3ccbf4a24acbe8f3fc4d973ab46b1a">opae_vfio_open</a>(&amp;v, <span class="stringliteral">&quot;0000:00:00.0&quot;</span>)) {</div>
<div class="line">  <span class="comment">// handle error</span></div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  sz = 2 * 1024 * 1024;</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a63c468f18994a45604b372c31a1e26cf">opae_vfio_buffer_allocate</a>(&amp;v,</div>
<div class="line">                                &amp;sz,</div>
<div class="line">                                &amp;buf_2m_virt,</div>
<div class="line">                                &amp;buf_2m_iova)) {</div>
<div class="line">    <span class="comment">// handle allocation error</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  sz = 1024 * 1024 * 1024;</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a63c468f18994a45604b372c31a1e26cf">opae_vfio_buffer_allocate</a>(&amp;v,</div>
<div class="line">                                &amp;sz,</div>
<div class="line">                                &amp;buf_1g_virt,</div>
<div class="line">                                &amp;buf_1g_iova)) {</div>
<div class="line">    <span class="comment">// handle allocation error</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
</div>
<a id="ae2a60d829698d793ab9a4ad351d2596d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae2a60d829698d793ab9a4ad351d2596d">&#9670;&nbsp;</a></span>opae_vfio_buffer_free()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opae_vfio_buffer_free </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>buf</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Unmap and free a system buffer</p>
<p>The buffer corresponding to buf must have been created by a previous call to opae_vfio_buffer_allocate.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">v</td><td>The open OPAE VFIO device. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buf</td><td>The virtual address corresponding to the buffer to be freed. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Non-zero on error. Zero on success.</dd></dl>
<p>Example </p><div class="fragment"><div class="line"><span class="keywordtype">size_t</span> sz;</div>
<div class="line">uint8_t *buf_2m_virt = NULL;</div>
<div class="line">uint64_t buf_2m_iova = 0;</div>
<div class="line"> </div>
<div class="line">sz = 2 * 1024 * 1024;</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a63c468f18994a45604b372c31a1e26cf">opae_vfio_buffer_allocate</a>(&amp;v,</div>
<div class="line">                              &amp;sz,</div>
<div class="line">                              &amp;buf_2m_virt,</div>
<div class="line">                              &amp;buf_2m_iova)) {</div>
<div class="line">  <span class="comment">// handle allocation error</span></div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  <span class="comment">// use the buffer</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#ae2a60d829698d793ab9a4ad351d2596d">opae_vfio_buffer_free</a>(&amp;v, buf_2m_virt)) {</div>
<div class="line">    <span class="comment">// handle free error</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
</div>
<a id="a70fd22e64704c8f0090adb810d51fa83"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a70fd22e64704c8f0090adb810d51fa83">&#9670;&nbsp;</a></span>opae_vfio_close()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void opae_vfio_close </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="vfio_8h.html#structopae__vfio">opae_vfio</a> *&#160;</td>
          <td class="paramname"><em>v</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Release and close a VFIO device</p>
<p>The given device pointer must have been previously initialized by opae_vfio_open. Releases all data structures, including any DMA buffer allocations that have not be explicitly freed by opae_vfio_buffer_free.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>Storage for the device info. May be stack-resident.</td></tr>
  </table>
  </dd>
</dl>
<p>Example </p><div class="fragment"><div class="line"><a class="code" href="vfio_8h.html#structopae__vfio">opae_vfio</a> v;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="vfio_8h.html#a3d3ccbf4a24acbe8f3fc4d973ab46b1a">opae_vfio_open</a>(&amp;v, <span class="stringliteral">&quot;0000:00:00.0&quot;</span>)) {</div>
<div class="line">  <span class="comment">// handle error</span></div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  <span class="comment">// interact with the device</span></div>
<div class="line">  ...</div>
<div class="line">  <span class="comment">// free the device</span></div>
<div class="line">  <a class="code" href="vfio_8h.html#a70fd22e64704c8f0090adb810d51fa83">opae_vfio_close</a>(&amp;v);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Example </p><div class="fragment"><div class="line">$ sudo opaevfio -r 0000:00:00.0</div>
</div><!-- fragment --> 
</div>
</div>
</div><!-- contents -->
<div class="ttc" id="avfio_8h_html_a70fd22e64704c8f0090adb810d51fa83"><div class="ttname"><a href="vfio_8h.html#a70fd22e64704c8f0090adb810d51fa83">opae_vfio_close</a></div><div class="ttdeci">void opae_vfio_close(struct opae_vfio *v)</div></div>
<div class="ttc" id="avfio_8h_html_afc30450c9b7ebc22709557cac5ab9181"><div class="ttname"><a href="vfio_8h.html#afc30450c9b7ebc22709557cac5ab9181">opae_vfio_region_get</a></div><div class="ttdeci">int opae_vfio_region_get(struct opae_vfio *v, uint32_t index, uint8_t **ptr, size_t *size)</div></div>
<div class="ttc" id="avfio_8h_html_a8d6d1f473a26bc0fbe83e6894b8fb607"><div class="ttname"><a href="vfio_8h.html#a8d6d1f473a26bc0fbe83e6894b8fb607">opae_vfio_secure_open</a></div><div class="ttdeci">int opae_vfio_secure_open(struct opae_vfio *v, const char *pciaddr, const char *token)</div></div>
<div class="ttc" id="avfio_8h_html_structopae__vfio"><div class="ttname"><a href="vfio_8h.html#structopae__vfio">opae_vfio</a></div><div class="ttdef"><b>Definition:</b> <a href="vfio_8h_source.html#l00132">vfio.h:132</a></div></div>
<div class="ttc" id="avfio_8h_html_a3d3ccbf4a24acbe8f3fc4d973ab46b1a"><div class="ttname"><a href="vfio_8h.html#a3d3ccbf4a24acbe8f3fc4d973ab46b1a">opae_vfio_open</a></div><div class="ttdeci">int opae_vfio_open(struct opae_vfio *v, const char *pciaddr)</div></div>
<div class="ttc" id="avfio_8h_html_ae2a60d829698d793ab9a4ad351d2596d"><div class="ttname"><a href="vfio_8h.html#ae2a60d829698d793ab9a4ad351d2596d">opae_vfio_buffer_free</a></div><div class="ttdeci">int opae_vfio_buffer_free(struct opae_vfio *v, uint8_t *buf)</div></div>
<div class="ttc" id="avfio_8h_html_a63c468f18994a45604b372c31a1e26cf"><div class="ttname"><a href="vfio_8h.html#a63c468f18994a45604b372c31a1e26cf">opae_vfio_buffer_allocate</a></div><div class="ttdeci">int opae_vfio_buffer_allocate(struct opae_vfio *v, size_t *size, uint8_t **buf, uint64_t *iova)</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
